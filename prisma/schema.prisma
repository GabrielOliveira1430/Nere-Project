datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  professional Professional?
  patient      Patient?
}

model Professional {
  id     String @id @default(uuid())
  userId Int    @unique

  cpf String?
  crf String?
  score Int? 

  user        User          @relation(fields: [userId], references: [id])
  jornadas    Jornada[]
  plantoes    Plantao[]
  trackings   Tracking[]
  checkins    Checkin[]
  Escala      Escala[]
  Atendimento Atendimento[]
}


model Patient {
  id        String   @id @default(uuid())
  userId    Int      @unique
  createdAt DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id])
  locais       Local[]
  atendimentos Atendimento[]
}

model Regime {
  id             String  @id @default(uuid())
  nome           String
  tipo           String
  horasMaxDia    Int
  horasMaxSemana Int
  permitePlantao Boolean @default(false)

  jornadas Jornada[]
}

model Jornada {
  id             String    @id @default(uuid())
  professionalId String
  regimeId       String
  dataInicio     DateTime?
  dataFim        DateTime?
  inicio         String?
  fim            String?
  intervaloMin   Int?
  tipo           String

  professional Professional @relation(fields: [professionalId], references: [id])
  regime       Regime       @relation(fields: [regimeId], references: [id])
  plantoes     Plantao[]
}

model Plantao {
  id             String   @id @default(uuid())
  jornadaId      String
  profissionalId String?
  data           DateTime
  status         String   @default("PENDENTE")

  jornada      Jornada       @relation(fields: [jornadaId], references: [id])
  profissional Professional? @relation(fields: [profissionalId], references: [id])

  atendimentos Atendimento[]
  checkins     Checkin[]
  trackings    Tracking[]
  escalas      Escala[]
  Atividade    Atividade[]
  Local        Local?        @relation(fields: [localId], references: [id])
  localId      String?
}

model Escala {
  id             String @id @default(uuid())
  plantaoId      String
  professionalId String

  plantao      Plantao      @relation(fields: [plantaoId], references: [id])
  professional Professional @relation(fields: [professionalId], references: [id])
}

model Atendimento {
  id             String    @id @default(uuid())
  pacienteId     String
  professionalId String?
  plantaoId      String?
  status         String
  inicioPrevisto DateTime
  fimPrevisto    DateTime
  inicioReal     DateTime?
  fimReal        DateTime?
  localId        String

  paciente     Patient       @relation(fields: [pacienteId], references: [id])
  professional Professional? @relation(fields: [professionalId], references: [id])
  plantao      Plantao?      @relation(fields: [plantaoId], references: [id])
  local        Local         @relation(fields: [localId], references: [id])

  atividades   Atividade[]
  pagamento    Pagamento?
  deslocamento Deslocamento?
}

model Atividade {
  id              String  @id @default(uuid())
  atendimentoId   String?
  plantaoId       String?
  tipo            String
  estado          String
  duracaoPrevista Int?
  duracaoReal     Int?

  atendimento Atendimento? @relation(fields: [atendimentoId], references: [id])
  plantao     Plantao?     @relation(fields: [plantaoId], references: [id])
}

model Local {
  id        String  @id @default(uuid())
  nome      String?
  endereco  String
  latitude  Float
  longitude Float
  tipo      String?

  pacientes    Patient[]
  plantoes     Plantao[]
  atendimentos Atendimento[]
}

model Deslocamento {
  id            String @id @default(uuid())
  atendimentoId String @unique
  origemLat     Float
  origemLon     Float
  destinoLat    Float
  destinoLon    Float
  tempoEstimado Int?
  tempoReal     Int?
  distancia     Float?

  atendimento Atendimento @relation(fields: [atendimentoId], references: [id])
}

model Pagamento {
  id             String   @id @default(uuid())
  atendimentoId  String   @unique
  valorBruto     Float
  taxaPlataforma Float
  valorLiquido   Float
  status         String
  dataGeracao    DateTime @default(now())

  atendimento Atendimento @relation(fields: [atendimentoId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  entity    String
  entityId  String
  action    String
  userId    String?
  timestamp DateTime @default(now())
  payload   Json?
}

model Checkin {
  id                String    @id @default(uuid())
  profissionalId    String
  plantaoId         String
  latitude          Float
  longitude         Float
  observacao        String?
  checkinAt         DateTime  @default(now())
  checkoutAt        DateTime?
  checkoutLatitude  Float?
  checkoutLongitude Float?

  profissional Professional @relation(fields: [profissionalId], references: [id])
  plantao      Plantao      @relation(fields: [plantaoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tracking {
  id             String   @id @default(uuid())
  profissionalId String
  plantaoId      String
  latitude       Float
  longitude      Float
  speed          Float?
  bearing        Float?
  accuracy       Float?
  createdAt      DateTime @default(now())

  profissional Professional @relation(fields: [profissionalId], references: [id])
  plantao      Plantao      @relation(fields: [plantaoId], references: [id])
}
